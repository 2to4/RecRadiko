# CLAUDE.md

このファイルは、このリポジトリでコードを扱う際にClaude Code (claude.ai/code)にガイダンスを提供します。

## プロジェクト概要

RecRadikoは、Radiko（日本のインターネットラジオ配信サービス）のタイムフリー機能を活用した専用録音システムです。HLS制約（5分制限）を回避し、過去1週間の番組を高品質で完全録音できるPythonアプリケーションです。

**現在の状態**: **Phase 6完全達成** - 地域統合・安定性向上・品質改善完了。プロダクション品質システム完成・運用準備完了。

## 🎯 **現在の開発目標**

### 主要機能（実装完了）
1. **過去番組表取得**: 日付指定による番組一覧表示・メニューベースページング対応
2. **タイムフリー録音**: 日付・番組名指定による完全録音・デスクトップ固定保存
3. **高品質録音**: HLS制約回避による2.5時間番組も完全対応
4. **メタデータ対応**: ID3タグ自動埋め込み（常時実行・設定不要）
5. **キーボードナビゲーションUI**: シンプル・直感的操作・最適化済み

### パフォーマンス実績
- **録音速度**: 10分番組を5.48秒で録音完了（実時間の1/110高速処理）
- **並行処理**: 8セグメント同時ダウンロード（平均107セグメント/秒）
- **品質**: MP3 256kbps, 48kHz, ID3タグ付き高品質録音（99.99%時間精度）


## 🏗️ **アーキテクチャ**

### タイムフリー専用コアモジュール (`src/`)
- `timefree_recorder.py`: タイムフリー専用録音システム
- `program_history.py`: 過去番組表管理・検索
- `auth.py`: タイムフリー認証システム
- `streaming.py`: タイムフリー専用ストリーミング
- `program_info.py`: 番組情報管理
- `cli.py`: タイムフリー専用対話型CLI
- `region_mapper.py`: 47都道府県対応地域設定
- `utils/`: 共通ユーティリティ

### キーボードナビゲーションUI (`src/ui/`)
- `screens/`: 画面実装（メインメニュー・地域選択・日付選択・番組選択・設定）
- `input/`: キーボード入力処理
- `services/`: UI共通サービス  
- `recording_workflow.py`: 録音ワークフロー統合（デスクトップ固定保存対応）

### テストスイート (`tests/`)
- **単体テスト**: 各モジュールの機能テスト
- **統合テスト**: タイムフリーAPI統合テスト
- **UIテスト**: キーボードナビゲーションテスト
- **E2Eテスト**: 実際のRadiko APIを使用した完全フローテスト

## 🎮 **使用方法**

### 基本的な使用方法
```bash
# キーボードナビゲーションUIモード（デフォルト）
python RecRadiko.py

# ヘルプ表示
python RecRadiko.py --help
```

### UI操作方法
- **↑↓キー**: メニュー選択・ナビゲーション
- **Enterキー**: 決定・実行
- **Escキー**: 戻る・キャンセル
- **Ctrl+C**: 終了

### 録音ファイル保存先
- **固定保存先**: `~/Desktop/RecRadiko/`
- **自動作成**: フォルダが存在しない場合は自動作成
- **ファイル名形式**: `{放送局ID}_{日付}_{時刻}_{番組名}.mp3`
- **ID3タグ**: 番組情報が自動で埋め込まれます

## 🔧 **開発環境セットアップ**

```bash
# 依存関係をインストール
pip install -r requirements.txt

# メインスクリプトを実行
python RecRadiko.py

# テスト実行
python -m pytest tests/ -v

# 特定のモジュールのテスト
python -m pytest tests/ui/test_settings_screen.py -v
```

## 🚨 **開発ルール**

### 基本方針
- **常に日本語で返答**: すべての開発作業・コミュニケーションは日本語で実施
- **テスト駆動開発**: t_wadaのテスト駆動手法を厳格に適用

### テスト駆動開発（TDD）手法
**t_wadaのテスト駆動開発定義に従い、以下の手順を厳守：**

1. **テストリスト作成**: 網羅したいテストシナリオのリストを書く
2. **Red（失敗）**: テストリストから「ひとつだけ」選び出し、実際に、具体的で、実行可能なテストコードに翻訳し、テストが失敗することを確認する
3. **Green（成功）**: プロダクトコードを変更し、いま書いたテスト（と、それまでに書いたすべてのテスト）を成功させる（その過程で気づいたことはテストリストに追加する）
4. **Refactor（改善）**: 必要に応じてリファクタリングを行い、実装の設計を改善する
5. **Repeat（繰り返し）**: テストリストが空になるまでステップ2に戻って繰り返す

### 必須開発手順
1. **コード変更前**: 既存テストが全て成功していることを確認
2. **新機能実装時**: TDD手法でテストケース先行作成・実装
3. **コード変更後**: 必ずテスト実行・成功確認
4. **テスト失敗時**: 新しいコードはコミット・使用禁止

### テスト実装方針
- **実環境優先**: 実際のファイル・設定・暗号化処理を使用
- **統合テスト重視**: 包括的統合テストによる品質保証
- **モック使用制限**: 外部API・システム操作・UI入力のみ（10%以下）

### ブランチ運用
- **開発**: `development`ブランチで実施
- **本番**: `main`ブランチは安定版
- **コミット**: 機能単位でコミット・詳細なメッセージ

### 品質基準
- **テストカバレッジ**: 95%以上維持
- **キー応答時間**: < 50ms
- **画面遷移時間**: < 100ms
- **日本語対応**: 全応答・ドキュメント・コメントは日本語（変数名は英語可）
- **TDD準拠**: テスト先行開発の徹底実施

### 不明点確認の徹底
仕様や要件が不明な場合は必ず確認し、勝手に推測して実装することは禁止。

## 📈 **Phase 7実績（2025年7月22日完了）**

### 🎯 **テスト品質向上・カバレッジ最大化**
- **timefree_recorder.py カバレッジ**: 84% → **87%** に向上
- **新規テスト追加**: test_38 〜 test_47（10個の包括的テスト）
- **カバー行数**: 346行中 **302行カバー**（未カバー44行）
- **品質改善項目**:
  - RecordingResult・TimeFreeAuthError詳細テスト
  - 深夜番組処理パス完全カバー
  - エラーハンドリング強化（_embed_metadata, _get_media_duration）
  - プログレス表示・例外処理パス
  - エッジケース・境界値テスト拡充

### 🚀 **技術的成果**
- **TDD手法**: t_wada準拠のテスト駆動開発徹底
- **実環境テスト**: モック使用率<10%、実ファイル・暗号化処理活用
- **統合テスト**: 包括的な品質保証体制確立
- **コード品質**: 高品質・保守性の高いテストスイート構築

---

## 🎯 **今後の開発計画**

### ⚡ **Phase 8: 音質オプション拡張（2025年7月22日開始）**

#### 🎵 **拡張仕様**
**現在**: 4音質オプション → **目標**: 8音質オプション

**追加予定音質オプション**:
- MP3 320kbps, 48kHz（超高品質）
- MP3 VBR V0, 48kHz（可変最高品質）
- AAC 320kbps, 48kHz（AAC超高品質）  
- AAC VBR ~256kbps, 48kHz（AAC可変高品質）

#### 🔧 **実装手順（TDD準拠）**
1. **FFmpeg音質オプション設計・仕様策定**
   - VBRコマンド仕様策定・品質レベル定義
   - 320kbps固定ビットレート仕様
   - FFmpegコマンド生成ロジック設計

2. **音質設定UI拡張**
   - 8オプションメニュー追加・表示改善
   - VBR説明テキスト・品質説明追加
   - 設定画面ユーザビリティ向上

3. **timefree_recorder.py音質処理拡張**
   - FFmpegコマンド生成ロジック拡張
   - VBR対応処理・エラーハンドリング追加
   - 音質設定読み込み・適用機能強化

4. **品質保証テスト追加**
   - 各音質オプション動作テスト
   - ファイルサイズ・音質検証テスト
   - エラーケース・境界値テスト

#### 🎯 **技術仕様**
```python
# 320kbps固定ビットレート
extra_args = ['-b:a', '320k']

# VBR（可変ビットレート）
mp3_vbr_args = ['-q:a', '0']      # MP3 VBR V0 (最高品質)
aac_vbr_args = ['-q:a', '0.4']    # AAC VBR ~256kbps相当
```

### 🎨 **Phase 9候補（将来的な拡張）**
1. **GUI機能実装**: tkinter/PyQtによるグラフィカルUI（視覚的操作性向上）
2. **macOSアプリケーション化**: PyInstaller・コード署名・DMGインストーラー
3. **高度な機能**: EPGデータ統合・アーカイブ管理・クラウド連携
4. **国際化**: 多言語対応・地域設定拡張・海外ラジオ対応

---

**プロジェクト状態**: **Phase 7完全達成 - テスト品質向上・高カバレッジ達成**  
**開発開始**: 2025年7月13日 | **Phase 6完了**: 2025年7月17日 | **Phase 7完了**: 2025年7月22日 | **最終更新**: 2025年7月22日  

**Ready for Production** 🚀