# CLAUDE.md

このファイルは、このリポジトリでコードを扱う際にClaude Code (claude.ai/code)にガイダンスを提供します。

## プロジェクト概要

RecRadikoは、Radiko（日本のインターネットラジオ配信サービス）のタイムフリー機能を活用した専用録音システムです。HLS制約（5分制限）を回避し、過去1週間の番組を高品質で完全録音できるPythonアプリケーションです。

**現在の状態**: **プロダクション品質完全達成・大幅リファクタリング完了** - 404エラー完全解決、Radiko API 2025年仕様完全対応、実際番組録音成功達成（10分番組99.99%精度録音）、40%コード削減による軽量化完了（10,881行→6,412行）。**RecRadikoはTimeFreeRecorder中心の単純・高効率なタイムフリー専用システムとして進化完了。**

## タイムフリー専用アプリケーション開発計画

### 背景と課題解決

**HLS制約問題**: ライブ録音はRadikoのHLSプロトコル制約により最大5分間の録音制限が存在し、長時間番組の録音が不可能でした。

**解決方針**: タイムフリーAPI専用システムへの全面移行により、過去1週間の番組を制限なく完全録音可能にします。

### 🎯 **開発目標**

#### 主要機能
1. **過去番組表取得**: 日付指定による番組一覧表示
2. **タイムフリー録音**: 日付・番組名指定による完全録音
3. **高品質録音**: HLS制約回避による2.5時間番組も完全対応
4. **メタデータ対応**: ID3タグ自動埋め込み（番組名、出演者、放送局、日付）
5. **対話型UI**: 直感的なコマンド操作

#### パフォーマンス目標（実証済み）
- **録音速度**: 実証済み - 10分番組を5.48秒で録音完了（実時間の1/110高速処理）
- **並行処理**: 8セグメント同時ダウンロード（平均107セグメント/秒）
- **品質**: MP3 256kbps, 48kHz, ID3タグ付き高品質録音（99.99%時間精度）

## 🏆 **実証済み実績（2025年7月14日完全達成）**

### ✅ 実際番組録音成功
**番組**: 芹ゆう子　お気づきかしら（仮）  
**放送日時**: 2025年7月13日 05:05-05:15（10分間）  
**放送局**: TBSラジオ  

### 📊 録音品質実証データ
- **ファイルサイズ**: 19,218,905 bytes（18.33 MB）
- **セグメント処理**: 120個完全取得（失敗0個）
- **録音時間**: 5.48秒（実時間の1/110高速処理）
- **時間精度**: 99.99%（599.93秒/600秒、誤差0.07秒）
- **音質**: MP3 256kbps, 48kHz, ID3タグ付き
- **成功率**: 100%（セグメントダウンロード平均107個/秒）

### 🔧 システム動作実証
- **Radiko API**: 2025年仕様完全対応・認証システム100%動作
- **404エラー**: 完全解決（auth1エンドポイント修正、認証ヘッダー対応）
- **HLS制約**: タイムフリー専用システムにより完全回避
- **2段階プレイリスト**: playlist.m3u8 → chunklist.m3u8 完全対応
- **高速並行処理**: 8セグメント同時ダウンロード実証済み

### 📋 **開発フェーズ**

#### **フェーズ1: 基盤モジュール実装**（最高優先度）
**期間**: 2週間  
**担当**: システム開発チーム

**1.1 TimeFreeRecorder クラス実装**
- [✅] 基本録音機能実装
- [✅] 非同期セグメントダウンロード（8並行）
- [✅] プログレスバー統合
- [✅] エラーハンドリング

**1.2 ProgramHistoryManager クラス実装**
- [✅] 番組表XML取得・パース
- [✅] 番組検索機能（部分一致、日付範囲）
- [✅] キャッシュシステム（24時間有効）
- [✅] 番組ID生成ロジック

**1.3 ProgramInfo データクラス拡張**
- [✅] タイムフリー対応プロパティ追加
- [✅] メタデータ生成機能
- [✅] ファイル名生成機能
- [✅] キャッシュ用シリアライゼーション

**検証項目**:
- [✅] 番組表取得の動作確認（複数局・複数日）
- [✅] 番組検索精度の確認
- [✅] 基本録音機能の動作確認（短時間番組）

#### **フェーズ2: 認証システム拡張**（高優先度）
**期間**: 1週間

**2.1 タイムフリー認証実装**
- [✅] タイムフリー専用セッション取得
- [✅] セッションキャッシュ（1時間有効）
- [✅] URL生成ロジック
- [✅] 認証エラー自動リカバリー

**2.2 API統合強化**
- [✅] タイムフリーM3U8 URL生成
- [✅] プレイリスト取得・解析
- [✅] セグメントURL抽出

**検証項目**:
- [✅] タイムフリー認証の成功確認
- [✅] 複数番組での認証テスト
- [✅] セッション期限切れ処理の確認

#### **フェーズ3: CLI統合とコマンド体系**（高優先度）
**期間**: 1.5週間

**3.1 対話型CLI実装**
- [✅] タイムフリー専用コマンド体系
- [✅] タブ補完機能統合
- [✅] エラーメッセージ改善
- [✅] ヘルプシステム

**3.2 コマンド実装**
- [✅] `list-programs` - 番組表取得
- [✅] `record` - 日付・番組名指定録音
- [✅] `record-id` - 番組ID指定録音
- [✅] `search-programs` - 番組検索

**3.3 ユーザビリティ向上**
- [✅] プログレス表示改善
- [✅] エラーメッセージの日本語化
- [✅] 候補番組提示機能

**検証項目**:
- [✅] 全コマンドの動作確認
- [✅] ユーザビリティテスト
- [✅] エラーハンドリングの確認

#### **フェーズ4: パフォーマンス最適化**（中優先度）
**期間**: 1週間

**4.1 ダウンロード最適化**
- [ ] Connection pooling実装
- [ ] エクスポネンシャルバックオフ
- [ ] メモリ効率的なストリーミング処理
- [ ] 帯域幅制御

**4.2 ファイル処理最適化**
- [ ] FFmpeg統合改善
- [ ] メタデータ埋め込み最適化
- [ ] 一時ファイル管理改善

**検証項目**:
- [ ] 2.5時間番組の10分以内録音達成
- [ ] メモリ使用量測定
- [ ] CPU使用率最適化確認

#### **フェーズ5: ライブ録音機能無効化**（完了）
**期間**: 3日間

**5.1 既存機能削除**
- [✅] src/live_streaming.py の完全削除
- [✅] 関連するスケジューリング機能削除
- [✅] 将来録音機能の無効化

**5.2 設定移行**
- [✅] 既存設定ファイルの自動移行
- [✅] タイムフリー専用設定項目追加
- [✅] 後方互換性の確保

**検証項目**:
- [✅] 既存設定の正常移行確認
- [✅] 不要機能の完全削除確認
- [✅] システム動作の軽量化確認

#### **フェーズ6: 品質改善・テスト最適化**（完全達成）
**期間**: 1週間  
**状況**: **高品質化完全達成・統合テスト最適化完了**

**6.1 単体テスト品質保証（完全達成）**
- [✅] **単体テスト100%成功達成**（327/327件成功）
- [✅] TimeFreeRecorder完全成功（26件）
- [✅] ProgramHistory完全成功（40件）
- [✅] CLI統合完全成功（22件）
- [✅] 認証・ファイル管理・エラーハンドリング100%

**6.2 対話型システム品質保証（完全達成）**
- [✅] **CLI対話型テスト完全成功**（15/15件成功）
- [✅] **E2E対話型テスト完全成功**（13/13件成功）
- [✅] タイムフリー専用コマンド体系完全対応
- [✅] ユーザビリティ・エラーハンドリング完全検証

**6.3 統合テスト最適化（完全達成）**
- [✅] **タイムフリー統合テスト完全成功**（12/12成功100%）
- [✅] 古いライブ録音インターフェース完全除去完了
- [✅] E2E・統合テスト完全対応完了

**6.4 ドキュメント更新（完全達成）**
- [✅] README.md更新完了
- [✅] ユーザーマニュアル更新完了  
- [✅] 開発計画書更新（本ドキュメント）
- [✅] システム状況の最新情報反映完了

### 🔧 **技術仕様**

#### アーキテクチャ変更
```
【変更前】ライブ録音 + タイムフリー対応
RecRadiko.py → CLI → LiveStreaming → HLS制約(5分)

【変更後】タイムフリー専用システム
RecRadiko.py → CLI → TimeFree → 完全録音(無制限)
```

#### 新規モジュール
- **TimeFreeRecorder**: タイムフリー専用録音処理
- **ProgramHistoryManager**: 過去番組表管理・検索
- **ConcurrentSegmentDownloader**: 8並行高速ダウンロード

#### 削除対象モジュール
- **src/live_streaming.py**: HLS制約の原因となるライブ録音機能
- **関連スケジューリング**: 将来録音機能の削除

#### 対話型コマンド体系
```
RecRadiko> list-programs 2025-07-10 TBS
RecRadiko> record 2025-07-10 TBS 森本毅郎・スタンバイ!
RecRadiko> search-programs 森本毅郎
RecRadiko> record-id TBS_20250710_060000
RecRadiko> help
RecRadiko> exit
```

### 📊 **期待される成果**

#### 制約解決
- **HLS 5分制限**: 完全回避
- **長時間番組**: 2.5時間番組も対応
- **録音品質**: オリジナル音質保持

#### パフォーマンス向上
- **録音速度**: 従来比5-10倍高速化
- **メモリ効率**: ストリーミング処理による最適化
- **並行処理**: 8セグメント同時ダウンロード

#### ユーザビリティ向上
- **直感的操作**: シンプルな対話型コマンド
- **メタデータ対応**: ID3タグ自動埋め込み
- **検索機能**: 番組名・出演者での部分一致検索

### 🎯 **最優先タスク: キーボードナビゲーション対応UI実装**

#### 現在の実装状況
**設計完了**: UI仕様書・概要設計書・詳細設計書・テスト仕様書の完成
- [✅] UI_SPECIFICATION.md: 上下キー選択・エンター確定の仕様策定
- [✅] ARCHITECTURE_DESIGN.md: MenuManager・ScreenBase・UIServiceアーキテクチャ設計
- [✅] DETAILED_DESIGN.md: キーボード入力処理・ANSI対応・ハイライト表示設計
- [✅] TEST_SPECIFICATION.md: 単体・統合・E2Eテスト157個のテストケース設計

#### 実装計画 (4週間)

**Phase 1: 基盤実装 (Week 1)**（✅ **完全達成**）
- [✅] Day 1-2: `src/ui/input/keyboard_handler.py` - クロスプラットフォームキー入力処理
  - **実装完了**: KeyboardHandler（11テスト成功、Windows/macOS/Linux対応）
  - **テスト項目**: キーマッピング・プラットフォーム分岐・特殊キー検出
  - **技術成果**: ANSIエスケープシーケンス・msvcrt/termios統合
- [✅] Day 3-4: `src/ui/services/ui_service.py` - キーボードナビゲーション・ハイライト表示
  - **実装完了**: UIService（15テスト成功、循環選択・視覚フィードバック）
  - **テスト項目**: メニュー操作・ハイライト表示・ユーザー入力処理
  - **技術成果**: → マーク表示・ANSI反転・画面クリア機能
- [✅] Day 5-7: `src/ui/screen_base.py` + `menu_manager.py` - 画面基底・ナビゲーション制御
  - **実装完了**: ScreenBase（18テスト）+ MenuManager（15テスト成功）
  - **テスト項目**: 抽象基底クラス・画面ライフサイクル・スタック管理
  - **技術成果**: テンプレートメソッドパターン・戻るナビゲーション・状態管理

**📊 Phase 1 実装成果統計**:
- **テスト成功率**: 59/59 (100%) - KeyboardHandler(11) + UIService(15) + ScreenBase(18) + MenuManager(15)
- **TDDサイクル**: 完全遵守（Red→Green→Refactor）
- **プラットフォーム**: Windows/macOS/Linux完全対応
- **アーキテクチャ**: 抽象化・継承・依存性注入による高品質設計

**📊 Phase 2 実装成果統計（完全達成）**:
- **テスト成功率**: 144/144 (100%) - 基盤(59) + MainMenuScreen(17) + StationSelectScreen(18) + DateSelectScreen(23) + ProgramSelectScreen(27)
- **スクリーン完成**: MainMenu + StationSelect + DateSelect + ProgramSelect（4/4スクリーン完了）
- **統合機能**: RegionMapper・ProgramInfoManager・ProgramHistoryManager完全連携
- **実用機能**: 47都道府県対応・地域変更・放送局選択・日付選択・番組選択・ページング機能・ショートカットキー
- **3段階録音フロー**: Station→Date→Program選択完全実現

**Phase 2: Screen実装 (Week 2)**（✅ **完全達成**）
- [✅] Day 8-10: `src/ui/screen_base.py` - キーボード対応基底クラス（Phase 1で前倒し完了）
- [✅] Day 11-12: MainMenu・StationSelect・DateSelectScreen実装
  - [✅] **MainMenuScreen完成**: メインメニュー・録音履歴・設定・ヘルプ・終了確認（17テスト成功）
  - [✅] **StationSelectScreen完成**: 地域別放送局選択・RegionMapper統合・ProgramInfoManager連携（18テスト成功）
  - [✅] **DateSelectScreen完成**: 日付選択・タイムフリー期間対応・相対日付表示（23テスト成功）
- [✅] Day 13-14: ProgramSelectScreen・ページング機能実装
  - [✅] **ProgramSelectScreen完成**: 番組選択・ページング・ProgramHistoryManager統合（27テスト成功）

**Phase 3: 統合・最適化 (Week 3)**
- Day 15-17: 統合テスト・デバッグ・パフォーマンス調整
- Day 18-19: UI改善・ユーザビリティ向上・アクセシビリティ対応
- Day 20-21: ドキュメント更新・リリース準備

**Phase 4: 追加機能・拡張 (Week 4)**
- Day 22-24: 検索・設定・システム情報画面キーボード対応
- Day 25-26: パフォーマンス最適化・メモリ効率化
- Day 27-28: 最終品質保証・リリース判定

#### 技術仕様
**キーボード操作**:
- ↑/↓キー: リスト項目移動（循環選択対応）
- Enterキー: 選択確定・実行
- Escキー: 前画面に戻る・キャンセル
- Page↑/↓: 長いリストのページ送り（10項目単位）
- ショートカットキー: R（地域変更）、S（検索）、Q（終了）

**視覚的フィードバック**:
- → マークによる選択項目表示
- ANSI反転表示によるハイライト
- グレーアウトによる無効項目表示
- 区切り線による論理グループ分離

**既存モジュール統合仕様**:
- **MenuManager**: 既存CLI.pyと共存、段階的移行
- **UIService**: 既存TimeFreeRecorder・ProgramHistoryを継続使用
- **Screen実装**: 既存認証・地域設定システムをそのまま活用
- **設定ファイル**: 既存JSON設定との100%互換性維持

#### 品質基準
- **テストカバレッジ**: 95%以上
- **キー応答時間**: < 50ms
- **画面遷移時間**: < 100ms
- **既存機能互換性**: 100%維持

### 🚨 **開発ルール（TDD遵守）**

#### 必須開発手順
1. **コード変更前**: 既存テストが全て成功していることを確認
2. **新機能実装時**: 対応するテストケースを必ず作成
3. **コード変更後**: 必ずテスト実行・成功確認
4. **テスト失敗時**: 新しいコードはコミット・使用禁止

#### キーボードナビゲーション実装専用TDDワークフロー
1. **テスト先行**: `tests/ui/` 以下にテストケース作成
2. **Red**: テスト実行・失敗確認 `pytest tests/ui/ -v`
3. **Green**: 最小実装でテスト成功 `pytest tests/ui/ -v`
4. **Refactor**: コード改善・既存テスト維持
5. **統合確認**: 既存139テスト + 新UIテスト全成功確認

#### テスト戦略
- **単体テスト**: 各モジュールの機能テスト
- **結合テスト**: タイムフリーAPI統合テスト
- **E2Eテスト**: 実際のRadiko APIを使用した完全フローテスト
- **パフォーマンステスト**: 録音速度・メモリ使用量測定

---

## 📚 **過去の成果（参考）**

### 完全達成済み項目（2025年7月）
- **✅ 単体テスト完全成功**: 327/327個（100%成功率）
- **✅ 統合テスト完全成功**: 12/12個（100%成功率）
- **✅ 対話型テスト完全成功**: 28/28個（100%成功率）
- **✅ E2Eテスト完全成功**: 50/50個（100%成功率）
- **✅ 実際APIテスト成功**: 16/16個（100%成功率）
- **✅ 都道府県名対応**: 47都道府県完全対応の地域設定システム
- **✅ UserWarning抑制**: exit時の警告表示完全除去
- **✅ HLS制約問題特定**: 5分制限の根本原因分析完了
- **✅ タイムフリー専用システム**: 完全安定化達成

### 技術的課題と解決策
**❌ 克服できなかった制約**: ライブ録音のHLS 5分制限  
**✅ 根本的解決策**: タイムフリー専用システムへの全面移行

---

**開発開始日**: 2025年7月13日  
**プロジェクト状態**: タイムフリー専用システム完全安定化達成  
**現在のマイルストーン**: フェーズ6品質改善・統合テスト最適化（完全達成）  
**次のマイルストーン**: 実用性テスト・実際API動作確認

#### 🎯 **達成されたユーザー価値**:
- **高品質保証**: 単体テスト100%成功による完全な品質保証
- **設定簡素化**: 「JP13」→「東京」への直感的な地域指定
- **47都道府県網羅**: 全国どこでも利用可能
- **多様な入力形式**: 日本語・英語・略称すべてに対応
- **後方互換性**: 既存area_id設定も継続サポート
- **実用性保証**: 実際のRadiko APIでの完全動作確認

#### 📊 **技術成果**:
- **品質指標**: 単体テスト327/327成功、対話型テスト28/28成功
- **新規ファイル**: src/region_mapper.py + 関連テスト
- **テスト拡充**: タイムフリー専用テスト大幅追加
- **ドキュメント完全更新**: 全主要文書の都道府県名対応反映

---

### 📈 **フェーズ7: 品質改善完了後の次期計画**

#### **次期フェーズ1: コードリファクタリング**（高優先度）
**前提条件**: タイムフリー専用システムのテスト成功率90%以上達成後
**理由**: 安定したタイムフリー専用システムを基盤としたコード品質向上

**対象項目**:
- **重複コード統合**: 類似メソッドの共通化とユーティリティ関数の抽出
- **長大メソッドの分割**: 複雑なメソッドの機能分割とコード簡略化
- **コード構造の改善**: 循環依存の解決とモジュール構造の最適化
- **型ヒントの統一**: 型注釈の一貫性向上とIDEサポート強化
- **不要コードの削除**: 未使用コードやコメントアウトされたコードの削除

**目標**:
- コード量の20-30%削減
- 新機能開発時間の短縮
- バグ発生率の低減
- テスト成功率100%の継続維持

**TDD原則**:
- **テスト駆動**: 各リファクタリング後にタイムフリー専用テスト全件実行・成功確認
- タイムフリー専用システムのテストベースを活用したコード品質向上
- リファクタリング前後での機能同一性保証
- 実際のRadiko APIでの動作確認による実用性保証の継続
- 新機能追加時のテストケース必須作成

#### **次期フェーズ2: GUI機能の実装**（中優先度）
**前提条件**: タイムフリー専用システム完全安定化後
- **テスト駆動**: GUI機能のE2Eテスト作成・実行
- tkinterまたはPyQtによるGUI設計
- ユーザビリティの向上
- 直感的な操作インターフェース

#### **次期フェーズ3: 機能拡張**（低優先度）
**前提条件**: GUI実装完了後
- **テスト駆動**: 新機能のE2Eテスト作成・実行
- 高品質録音オプション
- 自動化機能の充実
- 実用性機能の追加

### 📊 **現在のシステム状況（2025年7月14日）**

#### **✅ 完全実装済み項目**
- **基盤システム**: 認証・番組情報・ストリーミング・エラーハンドリング（100%成功）
- **タイムフリー専用アーキテクチャ**: 完全移行完了
- **コア機能**: 都道府県名対応・地域設定システム
- **ライブ録音機能削除**: HLS制約問題の根本解決
- **実際番組録音成功**: 404エラー完全解決・プロダクション品質達成
- **大幅リファクタリング**: 40%コード削減・システム軽量化完了

#### **🎯 リファクタリング完了状況**
**フェーズ1: 基盤ユーティリティ実装**（✅完了）
- LoggerMixin・ユーティリティモジュール実装完了
- 8クラスにLoggerMixin適用・logger初期化パターン統一
- セッションファクトリ・パスユーティリティ適用

**フェーズ2A: 安全削除**（✅完了）
- スケジューラモジュール完全削除（1,399行）
- ライブストリーミング設定削除（133行）
- 関連テスト・CLI修正（1,090行）
- **削除効果**: 2,622行削除（25.8%削減）

**フェーズ2B: 録音ファイル管理機能完全削除**（✅完了）
- RecordingManager完全削除（849行）
- FileManager完全削除（812行）
- 関連テスト削除（1,296行）
- CLI統合修正・依存関係除去
- **削除効果**: 2,957行削除（追加13.7%削減）

#### **📈 リファクタリング成果（2025年7月14日現在）**
- **累計削除**: 5,579行（約40%削減）
- **現在コードベース**: 約6,412行（軽量化達成）
- **システム進化**: TimeFreeRecorder中心の単純・高効率システム
- **保守性**: 大幅向上（複雑なジョブ管理・ファイル管理システム削除）
- **機能**: 核心録音機能完全保持（Finder連携による実用性向上）

#### **🎯 次期優先事項**
**フェーズ3: コード品質向上フェーズ**（計画済み）
- 重複コード統合・長大メソッド分割
- 型ヒント完全化・コード品質向上
- 詳細計画: [REFACTORING_PLAN.md](docs/REFACTORING_PLAN.md)

**次期フェーズ1: コードリファクタリング**（計画済み）
- 重複コード統合・長大メソッド分割
- 型ヒント完全化・コード品質向上
- 詳細計画: [REFACTORING_PLAN.md](docs/REFACTORING_PLAN.md)

---

### 📚 **リファクタリング完了実績（2025年7月14日）**

#### **🎯 大幅リファクタリング完了項目**

**✅ フェーズ1: 基盤ユーティリティ実装**（完全達成）
- **LoggerMixin統一**: 8クラスにLoggerMixin適用、logger初期化パターン統一
- **ユーティリティモジュール**: datetime/path/network utilities実装
- **セッションファクトリ**: create_radiko_session()統一
- **削減効果**: 重複コード除去、保守性向上

**✅ フェーズ2A: 安全削除**（完全達成）
- **スケジューラモジュール削除**: src/scheduler.py（1,399行）完全削除
- **ライブストリーミング設定削除**: src/live_streaming_config.py（133行）削除
- **CLI・テスト修正**: 関連参照・テストケース完全除去（1,090行）
- **削除効果**: 2,622行削除（25.8%削減）

**✅ フェーズ2B: 録音ファイル管理機能完全削除**（完全達成）
- **RecordingManager削除**: src/recording.py（849行）完全削除
- **FileManager削除**: src/file_manager.py（812行）完全削除
- **関連テスト削除**: tests/test_recording.py + tests/test_file_manager.py（1,296行）削除
- **CLI統合修正**: インポート・初期化・依存関係完全除去
- **削除効果**: 2,957行削除（追加13.7%削減）

**✅ フェーズ2C: モジュール最適化**（完全達成）
- **Streamingモジュール最適化**: ライブストリーミング機能削除（96行削除）
- **CLIモジュール最適化**: ファイル管理機能のFinder連携化（46行削除）
- **E2Eテスト修正**: 削除されたモジュール参照の完全除去
- **削除効果**: 142行削除（追加1%削減）

#### **📊 リファクタリング総合成果**
- **累計削除行数**: 5,721行（約41%削減）
- **システム軽量化**: 10,881行 → 6,270行
- **アーキテクチャ進化**: TimeFreeRecorder中心の単純・高効率システム
- **保守性向上**: 複雑なジョブ管理・ファイル管理システム削除
- **機能保持**: 核心録音機能完全保持（Finder連携強化）

#### **✅ 過去の主要開発成果（参考）**

**タイムフリー専用システム転換**（基盤完成）
- HLS制約（5分制限）問題の根本解決
- タイムフリー専用アーキテクチャ構築
- 実際番組録音成功（99.99%精度達成）

**テスト品質保証システム**（完全達成）
  - 結合テストフレームワークの設計・実装
  - エンドツーエンド録音ワークフローテスト
  - CLI統合テスト（全コマンド）
  - スケジューリング統合テスト
  - モック設定の完全調整と構造問題修正
  - 25/25個の結合テストが100%成功

- ✅ **E2Eテストフレームワーク完全実装**（最優先・完了）
  - 包括的E2Eテスト環境の構築・Docker化・時間加速システム
  - A1-A4: ユーザージャーニーテスト（新規ユーザー～複雑スケジュール）
  - B1-B3: システム稼働テスト（24時間稼働・大量データ・並行処理）
  - C1-C3: 障害復旧テスト（ネットワーク・ストレージ・プロセス障害）
  - D1-D3: パフォーマンステスト（スケーラビリティ・リアルタイム・長期運用）
  - 50/50個のE2Eテストが100%成功し、プロダクション品質完全保証

- ✅ **実際のRadiko APIテスト実装・実用性保証**（最優先・完了）
  - 実際のRadiko APIを使用するE2Eテスト（R1-R8）の完全実装・動作確認
  - API契約テスト（C1-C3）による実際のAPI構造変更の早期検出
  - CI環境での条件付き実行設定（SKIP_REAL_API_TESTS環境変数対応）
  - Docker環境分離実行とテスト結果監視システム
  - **8/8個の実際APIテストが100%成功し、理論から実践への完全移行・実用性保証達成**

### 🚨 **緊急修正事項（最優先対応）**

#### ✅ **【緊急】放送局リスト取得のXMLパース修正**（完了）
- **問題**: `src/program_info.py`でXMLパース処理に重大な問題があり、放送局リストが空になる
- **修正内容**: Station ID取得方法（属性→子要素）、logo/banner URL要素名修正
- **検証結果**: JP14エリアで15局の正常取得確認済み

#### ✅ **【緊急】録音機能の型不整合修正**（完了） 
- **問題**: `src/cli.py:494`で`'str' object has no attribute 'id'`エラー
- **原因**: `create_recording_job`メソッドがオブジェクトではなく文字列を返す型不整合
- **修正結果**: 録音機能完全動作確認済み（TBSラジオ1分間録音成功、AAC/MP3対応）

#### ✅ **【緊急】テストモック構造の実際APIへの更新**（完了）
- **問題**: テストのモックXML構造が実際のRadiko APIと完全に乖離
- **影響**: 306テスト100%成功でも実用性に欠ける重大な品質問題
- **修正結果**: 実際のRadiko API構造に基づくテストモック修正完了、実際APIテスト追加

#### ✅ **【緊急】位置情報APIの応答形式修正**（完了）
- **問題**: `region` vs `region_name` vs `regionName` フィールド名の想定違い
- **影響**: 地域判定の誤動作、認証失敗（成功率60%程度）
- **修正結果**: 複数フィールド名パターン対応により認証成功率100%達成

#### ✅ **【緊急】時刻解析の柔軟性向上**（完了）
- **問題**: `%Y%m%d%H%M%S`固定想定、ISO8601形式等に未対応
- **影響**: 番組スケジュール取得失敗（成功率70%程度）
- **修正結果**: 複数時刻形式対応により番組スケジュール取得成功率100%達成

#### ✅ **【緊急】ストリーミングURL検証強化**（完了）
- **問題**: URL妥当性検証なし、HTMLエラーページ処理不可
- **影響**: 不正URLでの録音失敗、エラー診断困難
- **修正結果**: HLSストリーミング完全対応、M3U8プレイリスト処理100%成功
- **修正箇所**: `src/streaming.py:128-136` のURL・Content-Type検証

#### ✅ **【緊急】型安全性の向上**（完了）
- **問題**: `elem.text`が`None`時の`strip()`呼び出しで実行時エラー
- **影響**: 全モジュールでNoneTypeエラー多発可能性
- **修正結果**: 型安全な処理への変更完了、実行時エラー撲滅

#### ✅ **【緊急】実際API検証テストの追加**（完了）
- **問題**: 外部API依存機能で実際のAPIを一度もテストしていない
- **影響**: API構造変更や想定違いを検出できない
- **修正結果**: リアルタイムAPI調査完了、Radiko認証プロトコル更新、録音機能完全動作
- **追加内容**: 実際のRadiko APIテスト（R1-R10）+ API契約テスト（C1-C3）

#### ✅ **【緊急】録音時間制限バグの完全修正**（完了・2025-07-12）
- **問題**: 録音が指定時間に関わらず5分間しか録音されない重大バグ
- **原因**: `getattr(job, 'duration_seconds', 300)` パターンによる5分デフォルト強制
- **修正箇所**: 
  - `src/recording.py:532` - 時間制限ロジック修正
  - `src/live_streaming.py:946,986,995` - ライブ録音時間制限修正
- **修正結果**: 指定時間での正常録音確認（60秒指定→60秒録音）

#### ✅ **【緊急】FFmpeg変換エラーの完全修正**（完了・2025-07-12）
- **問題1**: 一時TSファイルパス生成バグ（MP3出力時にパス競合）
- **原因1**: `output_path.replace('.aac', '_temp.ts')` → MP3では置換されず同一パス
- **修正1**: `f"{base_path}_temp.ts"` → 全拡張子対応の安全なパス生成
- **問題2**: 出力形式に関係なく AAC コーデック固定
- **原因2**: FFmpeg `-c:a aac` 固定 → MP3出力でコーデックエラー
- **修正2**: 拡張子別コーデック選択（`.mp3`:`libmp3lame`, `.aac`:`aac`）
- **修正結果**: FFmpeg変換完全成功、`completed` ステータス達成

#### ✅ **【完全解決】ライブストリーミングセグメント取得制限**（完了・2025-07-12）
- **問題**: 録音時間制限とFFmpeg変換は修正済みだが、実際の録音が約15秒（3セグメント）で停止
- **根本原因特定**: Media Sequenceが固定（常に1）でスライディングウィンドウ方式のHLSストリーム
- **詳細分析結果**: 
  - HLSストリーム特性: 5秒間隔で1個の新規セグメント追加、60セグメント固定ウィンドウ
  - Media Sequence進行: 0（固定値のため、シーケンス番号ベース検出が機能しない）
  - URL循環パターン: 77個のユニークURL、75個が重複（スライディングウィンドウによる再利用）
- **修正内容**:
  - `src/live_streaming.py:259-343` - セグメント検出アルゴリズムの完全再設計
  - URL差分ベースの新規セグメント検出に変更（Media Sequence進行前提から脱却）
  - スライディングウィンドウ対応の古いURLクリーンアップ機能追加
  - 初回監視は最新1セグメントのみ、継続監視は新規URL検出ベース
- **修正結果**:
  - **セグメント成功率**: 100%（59/59セグメント、90秒録音）
  - **録音継続性**: 完全な時間制限対応（約15秒→90秒完全録音）
  - **ファイル品質**: 4.5MBの高品質録音ファイル生成成功
  - **変換効率**: 266%（TSセグメント→MP3変換効率）

#### ✅ **【完全解決】404エラー・実際番組録音成功達成**（完了・2025-07-14）
- **問題**: Radiko API 404エラーによりタイムフリー認証・録音が失敗
- **根本原因特定**: 
  - 認証エンドポイントの変更（`auth1_fms` → `auth1`）
  - 2025年Radiko API仕様変更への未対応
  - TimeFreeRecorderの古いAPI呼び出し方式
- **修正内容**:
  - `src/auth.py` - 認証エンドポイント修正、2025年仕様ヘッダー対応
  - `src/timefree_recorder.py` - 2段階プレイリスト対応、認証ヘッダー修正
  - Radiko API完全対応（playlist → chunklist処理）
- **修正結果**:
  - **404エラー**: 完全解決（認証成功率100%）
  - **実際番組録音成功**: 「芹ゆう子　お気づきかしら（仮）」10分番組完全録音
  - **時間精度**: 99.99%（599.93秒/600秒、誤差0.07秒）
  - **処理速度**: 実時間の1/110（10分→5.48秒）
  - **音質**: MP3 256kbps, 48kHz, ID3タグ付き（18.33MB）
  - **成功率**: 100%（120/120セグメント完全取得）

### 🔧 **新機能追加とテストケース強化**（完了）

#### ✅ **通知システムの改善**（完了）
- **改善内容**: macOS標準通知システム（osascript）の導入
- **解決した問題**: `pyobjus`モジュール不足によるplyer通知エラー
- **フォールバック機能**: macOS標準 → plyer → ログ出力の3段階フォールバック
- **追加テストケース**: 5個
  - `test_macos_notification_system`: macOS標準通知の動作確認
  - `test_notification_fallback_system`: フォールバック機能の動作確認
  - `test_notification_non_macos`: 非macOS環境での動作確認
  - `test_notification_disabled`: 通知無効化機能の動作確認
  - `test_notification_on_health_change`: ヘルスチェック通知の動作確認

#### ✅ **認証システムのリトライ機能**（完了）
- **改善内容**: 最大3回のリトライ機能と段階的エラーログ
- **解決した問題**: 一時的なネットワークエラーによる認証失敗
- **技術仕様**: 1秒間隔でのリトライ、段階的ログレベル変更（warning → error）
- **追加テストケース**: 4個
  - `test_authentication_retry_mechanism`: 3回リトライ機能の動作確認
  - `test_authentication_max_retries_exceeded`: リトライ上限超過の動作確認
  - `test_authentication_immediate_success`: 即座成功時の動作確認
  - `test_authentication_partial_retry`: 部分リトライ機能の動作確認

#### ✅ **CLI予約録音インターフェースの修正**（完了）
- **改善内容**: `add_schedule`メソッドの引数を位置引数に変更
- **解決した問題**: `'station_id'`キーワード引数エラー
- **技術仕様**: 第1引数をstation_idとして位置引数で渡す方式に変更
- **追加テストケース**: 4個
  - `test_schedule_command_positional_args`: 位置引数での正常動作確認
  - `test_schedule_command_with_repeat_pattern`: 繰り返しパターンでの動作確認
  - `test_schedule_command_error_handling`: エラーハンドリング機能の動作確認
  - `test_schedule_command_exception_handling`: 例外処理機能の動作確認

#### ✅ **対話型モードの包括的テスト実装**（完了）
- **改善内容**: 対話型CLIモードの単体テスト、結合テスト、エンドツーエンドテストの完全実装
- **解決した問題**: 対話型機能の品質保証とユーザー体験の検証
- **技術仕様**: コマンド解析、セッション管理、エラーハンドリング、ユーザーフロー検証
- **追加テストケース**: 27個
  - **単体テスト（15個）**: ヘルプ表示、コマンド解析、引数処理、エラーハンドリング、セッション制御
  - **結合テスト（12個）**: コンポーネント統合、データベース連携、設定管理、ユーザーワークフロー
  - **E2Eテスト設計**: 実際のプロセス実行、対話型セッション、パフォーマンス、並行操作安全性

#### ✅ **都道府県名対応機能の完全実装**（完了・2025-07-12）
- **改善内容**: 47都道府県完全対応の直感的地域設定システム
- **解決した問題**: 「JP13」等の技術的IDによる複雑な初期設定
- **技術仕様**: RegionMapperクラス・設定分離設計・CLIコマンド統合
- **実装箇所**: 
  - `src/region_mapper.py` - 都道府県名⇔地域IDマッピングシステム
  - `src/cli.py` - show-region・list-prefectures コマンド追加
  - 設定ファイル分離: prefecture保存⇔area_id自動変換（メモリ内のみ）
- **追加テストケース**: 3個（実際API環境での動作確認）
  - `R6: test_real_prefecture_configuration`: 5都道府県での設定テスト
  - `R7: test_real_multi_prefecture_authentication`: 複数地域での認証テスト
  - `R8: test_real_prefecture_cli_commands`: 都道府県CLIコマンドテスト
- **ユーザー価値**: 設定簡素化・47都道府県網羅・多様な入力形式対応・後方互換性維持

#### 📊 **テストケース追加統計**
- **通知システム**: 5個のテストケース追加
- **認証システム**: 4個のテストケース追加
- **CLIインターフェース**: 4個のテストケース追加
- **対話型モード**: 27個のテストケース追加（単体15個+結合12個）
- **タイムフリー統合**: 12個のテストケース最適化
- **合計**: 52個の新規・最適化テストケース
- **成功率**: 100%（全テストカテゴリー100%成功達成）

### 📈 **フェーズ2: コードリファクタリング計画策定完了**
**理由**: 完全なテストベース（367テスト100%成功+実際API動作確認）により、安心してコード品質向上に取り組める最適なタイミング

**現状分析結果**:
- ✅ 総行数: 7,661行、関数数: 285個、クラス数: 47個
- ✅ 長大メソッド: 38個（30行以上）を特定
- ✅ 重複コード: 384パターンを検出  
- ✅ 型ヒント: カバレッジ50.2%（142関数で不足）

**リファクタリング計画**:
- 📋 **詳細計画書**: [REFACTORING_PLAN.md](docs/REFACTORING_PLAN.md)
- 🎯 **4週間スケジュール**: 緊急修正 → 重複コード統合 → 長大メソッド分割 → 型ヒント完全化
- 📊 **期待効果**: コード量20-30%削減、型安全性90%+、保守性大幅向上

### フェーズ2: GUI機能の実装（高優先度）
**理由**: 安定したコードベースと完全なテスト環境が整ったため、ユーザーインターフェースの実装に集中可能。

**🚨 必須要件**: GUI機能の単体テスト作成・実行

**対象項目**:
- **GUI フレームワーク選定**: tkinter（標準ライブラリ）またはPyQt（高機能）
- **GUI モジュール設計**: 録音スケジュール管理、リアルタイム録音状態表示
- **ユーザビリティ向上**: 設定画面、番組検索インターフェース、録音履歴表示
- **GUI テストケース作成**: ユーザーインターフェースの品質保証

### フェーズ3: 機能拡張（中優先度）
**理由**: 安定したコードベースとGUI環境が整った後、新機能の追加でユーザー体験を向上。

**🚨 必須要件**: 新機能の包括的テストケース作成

**対象項目**:
- **ストリーミング品質向上**: 高品質録音オプション
- **番組情報の充実**: EPG データ統合、番組メタデータ
- **自動化機能**: 定期録音、アーカイブ管理
- **通知システム**: 録音開始/完了、エラー通知

### フェーズ4: タイムフリー機能対応（低優先度）
- **タイムフリーAPI統合**: 過去1週間分の番組データアクセス
- **過去番組録音機能**: 放送済み番組の録音・ダウンロード機能
- **タイムフリー番組検索**: 過去番組の検索・フィルタリング機能
- **録音履歴管理**: タイムフリー録音の履歴管理とメタデータ保存
- **UI拡張**: タイムフリー番組表示とスケジューリングのUI対応
- **認証拡張**: タイムフリー利用に必要な追加認証処理
- **エラーハンドリング**: タイムフリー特有のエラー（期限切れ等）への対応
- **テストケース**: タイムフリー機能の包括的テストスイート

### フェーズ5: macOS アプリケーション化（低優先度）
- **PyInstallerセットアップ**: Pythonアプリケーションの.app形式へのパッケージング
- **依存関係バンドル**: FFmpeg等の外部依存関係の.appファイル内への組み込み
- **Info.plistファイル作成**: macOSアプリケーション情報の定義
- **アプリケーションアイコン**: 高解像度対応のicnsファイル作成
- **コード署名対応**: macOS Gatekeeper対応のためのコード署名設定
- **Notarization対応**: Apple公証プロセスへの対応
- **自動更新機能**: アプリケーションの自動更新メカニズム
- **DMGインストーラー**: 配布用のDMGファイル作成とインストール手順
- **システム権限管理**: マイク・ネットワークアクセス権限の適切な要求
- **ファイル関連付け**: 録音ファイル形式とアプリケーションの関連付け
- **Dock統合**: Dockアイコンでの進捗表示・コンテキストメニュー
- **メニューバー統合**: macOSメニューバーでの基本操作対応

## 開発環境のセットアップ

```bash
# 依存関係をインストール
pip install -r requirements.txt

# メインスクリプトを実行
python RecRadiko.py

# 単体テストを実行
python -m pytest tests/ -v

# 特定のモジュールのテストを実行
python -m pytest tests/test_auth.py -v
```

## コードアーキテクチャ

プロジェクトは以下のモジュール構成になっています：

### タイムフリー専用コアモジュール (`src/`)
- `timefree_recorder.py`: タイムフリー専用録音システム（セグメント並行ダウンロード・高速処理）
- `program_history.py`: 過去番組表管理・検索（SQLiteキャッシュ・部分一致検索）
- `auth.py`: タイムフリー認証システム（Radiko API 2025年仕様対応）
- `streaming.py`: タイムフリー専用ストリーミング（M3U8プレイリスト処理）
- `program_info.py`: 番組情報管理（XMLパース・データ変換）
- `cli.py`: タイムフリー専用対話型CLI（list-programs、record、search-programs）
- `utils/`: 共通ユーティリティ（LoggerMixin、ネットワーク、パス、日時）

**🗑️ 削除されたモジュール（リファクタリング完了）**:
- ❌ `recording.py`: 複雑な並行録音管理システム（849行削除）
- ❌ `file_manager.py`: ファイル組織化・メタデータ管理（812行削除）
- ❌ `scheduler.py`: 将来録音・ジョブ管理システム（1,399行削除）
- ❌ `daemon.py`: バックグラウンド実行システム（1,347行削除）
- ❌ `live_streaming_config.py`: ライブ録音設定（133行削除）

### エントリーポイント
- `RecRadiko.py`: タイムフリー専用メインエントリーポイント

### タイムフリー専用テストスイート (`tests/`)
- **タイムフリー専用テスト**: 139個（100%成功・警告ゼロ）
  - TimeFreeRecorder（26個）: 並行ダウンロード・セグメント処理
  - ProgramHistory（40個）: 番組表取得・検索・SQLiteキャッシュ
  - CLI統合（22個）: 対話型コマンド・ユーザーインターフェース
  - 認証・ファイル管理（51個）: タイムフリー認証・エラーハンドリング
- pytestを使用したクリーンテスト環境
- モックを使用したネットワーク処理テスト

## 設計方針

### 1. モジュラー設計
- 各機能は独立したモジュールとして実装
- 依存関係は最小限に抑制
- インターフェースの一貫性を保持

### 2. エラーハンドリング
- 包括的なエラーハンドリングシステム
- 自動復旧機能
- 通知システムによる障害通知

### 3. 設定管理
- JSONベースの設定ファイル
- 暗号化された認証情報の保存
- 環境固有の設定サポート

### 4. テスト戦略
- **5層テスト構造**: 単体テスト（327個）→ 統合テスト（12個）→ 対話型テスト（28個）→ E2Eテスト（50個）→ 実際APIテスト（8個）
- **実用性保証**: 理論的テストから実際のAPI動作確認まで完全カバー
- **タイムフリー専用対応**: 全テストレイヤーでタイムフリー専用システム完全対応
- モックを使用した外部依存関係の分離
- 実際のRadiko APIを使用した実用性確認
- 継続的なテスト実行とCI/CD対応

## 🚨 必須開発ルール

### ⚠️ テスト駆動開発（TDD）の厳格な遵守

**【重要】ソースコード変更時の必須手順:**

1. **コード変更前**: 既存テストが全て成功していることを確認
   ```bash
   python -m pytest tests/ -v
   ```

2. **コード変更後**: 必ず単体テストを実行してテスト成功を確認
   ```bash
   python -m pytest tests/ -v
   ```

3. **テスト失敗時**: 新しいコードはコミット・使用禁止
   - テスト失敗の原因を特定・修正
   - 全テスト成功まで開発を停止

4. **新機能追加時**: 対応するテストケースを必ず作成
   - 機能実装と同時にテストも実装
   - テストカバレッジの維持・向上

**【理由】**:
- 現在テスト成功率100%（139/139）の安定したコードベースを維持
- 実際のAPI動作確認による実用性の完全保証
- リグレッション（機能退化）の防止
- コード品質の継続的な保証
- 開発者間での信頼性の共有
- エンタープライズグレードのプロダクション品質保証

**【例外】**:
- 例外は一切認めない
- すべてのコード変更は必ずテスト成功が前提

### 🌿 ブランチ運用ルールの厳格な遵守

**【重要】ソースコード編集時の必須ブランチ運用:**

1. **ソースコード編集は必ずdevelopmentブランチで実施**
   ```bash
   # 現在のブランチ確認
   git branch
   
   # developmentブランチでない場合は移動
   git checkout development
   ```

2. **mainブランチでの直接編集は禁止**
   - mainブランチは本番用の安定版
   - mainブランチでのソースコード変更は一切禁止

3. **開発完了後のマージフロー**
   ```bash
   # 1. developmentブランチで開発・テスト完了
   git checkout development
   # コード編集・テスト実行
   
   # 2. developmentブランチでコミット
   git add .
   git commit -m "機能追加・修正内容"
   
   # 3. mainブランチにマージ
   git checkout main
   git merge development
   ```

4. **ブランチ確認の徹底**
   - 編集開始前に必ず `git branch` で現在ブランチを確認
   - developmentブランチでない場合は即座に移動

**【理由】**:
- mainブランチの安定性保証
- 本番環境への意図しない変更防止
- 開発フローの一貫性維持
- レビュープロセスの品質向上

**【例外】**:
- ドキュメントのみの軽微な修正（CLAUDE.md、README.md等）でも開発ブランチを使用
- 例外は一切認めない

## 一般的な開発タスク

### テスト実行

#### 🔧 ログ設定について
RecRadikoは統一ログ設定を採用しており、テスト実行時の動作が以下のように制御されます：

- **通常使用時**: コンソール出力なし、ファイルログのみ（`recradiko.log`）
- **テスト実行時**: コンソール出力あり、詳細ログ表示
- **環境変数制御**: 手動でログ動作を制御可能

```bash
# 環境変数による手動制御
export RECRADIKO_CONSOLE_OUTPUT=true   # コンソール出力を強制有効
export RECRADIKO_LOG_LEVEL=DEBUG       # ログレベルを設定
export RECRADIKO_LOG_FILE=custom.log   # ログファイルを指定

# テスト実行時は自動的にコンソール出力が有効化されます
python -m pytest tests/ -v
```

#### 基本テスト実行
```bash
# タイムフリー専用テスト実行（推奨）
python -m pytest tests/ -v                    # 全体テスト（139個）

# コンポーネント別実行
python -m pytest tests/test_timefree_recorder.py -v     # TimeFreeRecorder（26個）
python -m pytest tests/test_program_history.py -v      # ProgramHistory（40個）
python -m pytest tests/test_cli.py -v                  # CLI統合（22個）

# 軽量システムのため統合・E2E・実際APIテストは除去済み
# （40%コード削減により複雑なテストスイートは不要）
```

#### タイムフリー専用機能テスト実行
```bash
# 認証システムテスト
python -m pytest tests/test_auth.py -k "timefree" -v

# 番組履歴管理テスト
python -m pytest tests/test_program_history.py -k "search" -v

# CLI対話型モードテスト
python -m pytest tests/test_cli.py -k "interactive" -v

# ユーティリティ機能テスト
python -m pytest tests/ -k "utils" -v
```

#### タイムフリー専用開発ワークフロー
```bash
# 基本開発サイクル（必須）
python -m pytest tests/ -v                    # タイムフリー専用テスト（139個）

# 重要変更時（推奨）  
python -m pytest tests/ -v --cov=src          # カバレッジ付きテスト実行

# 最重要変更時（リファクタリング等）
python -m pytest tests/ -v -x                 # 最初のエラーで停止（高速フィードバック）
```

#### 高度なテスト実行オプション
```bash
# カバレッジ付きテスト
python -m pytest tests/ --cov=src --cov-report=html

# 詳細ログ付きテスト実行
python -m pytest tests/ -v -s --tb=short

# 並列テスト実行（高速化）
python -m pytest tests/ -n auto

# 特定コンポーネントテスト
python -m pytest tests/test_timefree_recorder.py -v
python -m pytest tests/test_program_history.py -v
python -m pytest tests/test_cli.py -v
```

#### テスト環境の制御
```bash
# 通常使用時のログ動作確認
python -c "from src.logging_config import is_test_mode, is_console_output_enabled; print(f'Test mode: {is_test_mode()}, Console output: {is_console_output_enabled()}')"

# テスト環境での動作確認
PYTEST_CURRENT_TEST=test python -c "from src.logging_config import is_test_mode, is_console_output_enabled; print(f'Test mode: {is_test_mode()}, Console output: {is_console_output_enabled()}')"

# 手動コンソール出力制御
RECRADIKO_CONSOLE_OUTPUT=true python RecRadiko.py --help
```

### タイムフリー専用システム開発時の注意点
- **🚨 最重要**: ソースコード変更時は必ずdevelopmentブランチでテスト実行・成功確認
- **ブランチ確認**: 編集前に `git branch` で現在ブランチを確認
- **テスト実行**: タイムフリー専用テスト（139個）で機能品質確認
- **新機能追加時**: 対応するテストケースを必ず作成
- **外部API呼び出し**: モックを使用してテスト
- **ログ設定**: 統一ログ設定により、テスト時のみコンソール出力、通常使用時はファイルログのみ
- **設定変更時**: CLAUDE.mdも更新
- **コードスタイル**: PEP8に準拠
- **応答とドキュメントの作成は日本語で行う**

### タイムフリー専用開発ワークフロー（必須）
```bash
# 1. 開発ブランチ確認・移動
git branch                        # 現在ブランチ確認
git checkout development          # developmentブランチに移動

# 2. 変更前のテスト確認
python -m pytest tests/ -v       # タイムフリー専用テスト（139個）

# 3. コード変更・実装
# （developmentブランチでソースコード編集）

# 4. 変更後のテスト実行（必須）
python -m pytest tests/ -v       # 全テスト実行

# 5. テスト成功確認後にコミット可能
# ✅ タイムフリー専用テスト: 139/139 (100%)
# ✅ 警告ゼロのクリーンテスト環境

# 6. コミット・マージフロー
git add .
git commit -m "機能追加・修正内容"
git checkout main
git merge development
```

## 依存関係

### 主要な外部依存関係
- `requests`: HTTP通信
- `cryptography`: 暗号化処理
- `m3u8`: HLSストリーム処理
- `sqlite3`: データベース操作
- `argparse`: CLI引数処理

### 開発・テスト依存関係
- `pytest`: テストフレームワーク
- `pytest-cov`: カバレッジ測定
- `unittest.mock`: モックライブラリ

### GUI関連依存関係（将来的な追加予定）
- `tkinter`: 標準GUIライブラリ（Python標準搭載）
- `PyQt6` または `PySide6`: 高機能GUIフレームワーク（選択肢）

## トラブルシューティング

### よくある問題
1. **FFmpegが見つからない**: システムにFFmpegがインストールされていることを確認
2. **認証エラー**: 認証情報が正しく設定されているか確認
3. **テスト失敗**: 依存関係が正しくインストールされているか確認

### ログ出力
- エラーログ: `error.log`
- アプリケーションログ: `recradiko.log`
- 構造化エラー情報: `errors.json`