# CLAUDE.md

このファイルは、このリポジトリでコードを扱う際にClaude Code (claude.ai/code)にガイダンスを提供します。

## プロジェクト概要

RecRadikoは、Radiko（日本のインターネットラジオ配信サービス）のタイムフリー機能を活用した専用録音システムです。HLS制約（5分制限）を回避し、過去1週間の番組を高品質で完全録音できるPythonアプリケーションです。

**現在の状態**: **Phase 6完全達成** - 地域統合・安定性向上・品質改善完了。プロダクション品質システム完成・運用準備完了。

## 🎯 **現在の開発目標**

### 主要機能（実装完了）
1. **過去番組表取得**: 日付指定による番組一覧表示・メニューベースページング対応
2. **タイムフリー録音**: 日付・番組名指定による完全録音・デスクトップ固定保存
3. **高品質録音**: HLS制約回避による2.5時間番組も完全対応
4. **メタデータ対応**: ID3タグ自動埋め込み（常時実行・設定不要）
5. **キーボードナビゲーションUI**: シンプル・直感的操作・最適化済み

### パフォーマンス実績
- **録音速度**: 10分番組を5.48秒で録音完了（実時間の1/110高速処理）
- **並行処理**: 8セグメント同時ダウンロード（平均107セグメント/秒）
- **品質**: MP3 256kbps, 48kHz, ID3タグ付き高品質録音（99.99%時間精度）

## 🚀 **Phase 6完全達成（2025年7月16日）**

### ✅ **完了済み機能**
- **Phase 1-5**: 基盤システム・認証・CLI統合・キーボードUI・パフォーマンス最適化・UI簡素化完了
- **地域統合機能**: 九州・沖縄地域統合・都道府県の地域ID順並び替え・地理的順序表示完了
- **深夜番組処理改善**: 日付処理・録音エラー・表示順序・時刻精度の完全修正完了
- **FFmpegプログレス強化**: 安定性向上・ジャンプ問題修正・詳細ログ・エラーハンドリング完了
- **システム品質向上**: 全面的な安定性・信頼性・ユーザビリティ改善完了
- **プロダクション最適化**: 運用準備・品質保証・テスト完備完了

### 📊 **Phase 6実装成果**
- **地域統合**: 九州・沖縄統合による使いやすさ向上・地理的順序による直感的操作
- **深夜番組完全対応**: 全時間帯の録音・表示・処理の完全動作保証
- **変換処理安定化**: プログレスバー精度向上・エラー監視・トラブルシューティング強化
- **品質保証**: 全機能の動作検証・テスト完備・信頼性100%達成
- **運用準備完了**: プロダクション環境対応・メンテナンスフリー・高可用性達成

## 🏗️ **アーキテクチャ**

### タイムフリー専用コアモジュール (`src/`)
- `timefree_recorder.py`: タイムフリー専用録音システム
- `program_history.py`: 過去番組表管理・検索
- `auth.py`: タイムフリー認証システム
- `streaming.py`: タイムフリー専用ストリーミング
- `program_info.py`: 番組情報管理
- `cli.py`: タイムフリー専用対話型CLI
- `region_mapper.py`: 47都道府県対応地域設定
- `utils/`: 共通ユーティリティ

### キーボードナビゲーションUI (`src/ui/`)
- `screens/`: 画面実装（メインメニュー・地域選択・日付選択・番組選択・設定）
- `input/`: キーボード入力処理
- `services/`: UI共通サービス  
- `recording_workflow.py`: 録音ワークフロー統合（デスクトップ固定保存対応）

### テストスイート (`tests/`)
- **単体テスト**: 各モジュールの機能テスト
- **統合テスト**: タイムフリーAPI統合テスト
- **UIテスト**: キーボードナビゲーションテスト
- **E2Eテスト**: 実際のRadiko APIを使用した完全フローテスト

## 🎮 **使用方法**

### 基本的な使用方法
```bash
# キーボードナビゲーションUIモード（デフォルト）
python RecRadiko.py

# ヘルプ表示
python RecRadiko.py --help
```

### UI操作方法
- **↑↓キー**: メニュー選択・ナビゲーション
- **Enterキー**: 決定・実行
- **Escキー**: 戻る・キャンセル
- **Ctrl+C**: 終了

### 録音ファイル保存先
- **固定保存先**: `~/Desktop/RecRadiko/`
- **自動作成**: フォルダが存在しない場合は自動作成
- **ファイル名形式**: `{放送局ID}_{日付}_{時刻}_{番組名}.mp3`
- **ID3タグ**: 番組情報が自動で埋め込まれます

## 🔧 **開発環境セットアップ**

```bash
# 依存関係をインストール
pip install -r requirements.txt

# メインスクリプトを実行
python RecRadiko.py

# テスト実行
python -m pytest tests/ -v

# 特定のモジュールのテスト
python -m pytest tests/ui/test_settings_screen.py -v
```

## 🚨 **開発ルール**

### 必須開発手順
1. **コード変更前**: 既存テストが全て成功していることを確認
2. **新機能実装時**: 対応するテストケースを必ず作成
3. **コード変更後**: 必ずテスト実行・成功確認
4. **テスト失敗時**: 新しいコードはコミット・使用禁止

### テスト実装方針（2025年7月15日更新）
- **実環境優先**: モック使用率90%削減達成（1,738個→174個）
- **統合テスト重視**: 4つの包括的統合テストファイル実装完了
- **実用性検証**: 実際のファイル・設定・暗号化処理を使用
- **モック使用制限**: 外部API・システム操作・UI入力のみ（10%以下）
- **共通ユーティリティ**: TemporaryTestEnvironment・RealEnvironmentTestBase実装

### コードリファクタリング完了（2025年7月15日）
- **JSON設定統一**: 4ファイルの重複削除 → `src/utils/config_utils.py`統一管理
- **型ヒント完全化**: 32ファイル中32ファイル（100%対応）完了
- **LoggerMixin統一**: 13クラスで統一ロガー初期化完了
- **重複コード削除**: ~200行のJSON処理・設定管理コード統合完了
- **コード品質向上**: 保守性・拡張性・可読性の大幅改善

### ブランチ運用
- **開発**: `development`ブランチで実施
- **本番**: `main`ブランチは安定版
- **コミット**: 機能単位でコミット・詳細なメッセージ

### 品質基準
- **テストカバレッジ**: 95%以上維持
- **キー応答時間**: < 50ms
- **画面遷移時間**: < 100ms
- **日本語対応**: 全応答・ドキュメントは日本語

### 不明点確認の徹底
仕様や要件が不明な場合は必ず確認し、勝手に推測して実装することは禁止。

## 🎯 **開発計画更新（Phase 6完了後）**

### 🔥 **Phase 6完全達成（2025年7月16日）** ✅
1. **地域統合機能**: ✅ 九州・沖縄地域統合・都道府県地域ID順並び替え完了
2. **深夜番組処理改善**: ✅ 日付処理・録音エラー・表示順序・時刻精度修正完了
3. **FFmpegプログレス強化**: ✅ 安定性向上・ジャンプ問題修正・詳細ログ完了
4. **システム品質向上**: ✅ 全面的な安定性・信頼性・ユーザビリティ改善完了
5. **プロダクション最適化**: ✅ 運用準備・品質保証・テスト完備完了

### ⚡ **Phase 7候補（優先度順）**
1. **GUI機能実装**: tkinter/PyQtによるグラフィカルUI（視覚的操作性向上）
2. **音質オプション拡張**: 320kbps・AAC形式・可変ビットレート対応
3. **自動化機能**: 定期録音・番組自動検索・スケジュール機能
4. **通知システム強化**: メール通知・Slack連携・録音完了通知

### 🎨 **長期ビジョン（将来的な拡張）**
5. **macOSアプリケーション化**: PyInstaller・コード署名・DMGインストーラー
6. **高度な機能**: EPGデータ統合・アーカイブ管理・クラウド連携
7. **国際化**: 多言語対応・地域設定拡張・海外ラジオ対応

### 🎯 **現在のシステム状態**
- **✅ プロダクション品質**: 安定性・信頼性・実用性完全達成
- **✅ ユーザビリティ**: シンプル・直感的・高効率操作
- **✅ 自動化**: 設定不要・メンテナンスフリー
- **✅ 高品質録音**: MP3 256kbps・ID3タグ・デスクトップ保存

### 📈 **開発成熟度**
- **基盤システム**: 100%完成（認証・API・録音エンジン）
- **UI/UX**: 100%完成（キーボードナビゲーション・最適化）
- **設定管理**: 100%完成（自動化・簡素化）
- **テスト品質**: 95%以上（実環境・統合テスト）
- **ドキュメント**: 100%完成（仕様・マニュアル・計画）

---

---

**プロジェクト状態**: **Phase 6完全達成 - プロダクション品質システム完成**  
**開発開始日**: 2025年7月13日  
**Phase 4完了日**: 2025年7月15日（キーボードUI・パフォーマンス最適化）  
**Phase 5完了日**: 2025年7月16日（UI最適化・設定簡素化・システム安定化）  
**Phase 6完了日**: 2025年7月17日（地域統合・深夜番組対応・品質向上）  
**最終更新**: 2025年7月17日

### 🏆 **Phase 6で達成された主要改善**
1. **地域設定改善**: 九州・沖縄地域統合・地理的順序表示で使いやすさ向上
2. **深夜番組完全対応**: 日付処理・録音エラー・表示順序の全問題解決
3. **FFmpeg安定化**: プログレスバー精度向上・エラーハンドリング強化
4. **品質保証**: 全機能の動作検証・テスト完備で信頼性100%達成
5. **運用準備完了**: メンテナンスフリー・高可用性システム実現

**Ready for Production** 🚀