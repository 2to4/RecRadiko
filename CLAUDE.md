# CLAUDE.md

このファイルは、このリポジトリでコードを扱う際にClaude Code (claude.ai/code)にガイダンスを提供します。

## プロジェクト概要

RecRadikoは、Radiko（日本のインターネットラジオ配信サービス）のタイムフリー機能を活用した専用録音システムです。HLS制約（5分制限）を回避し、過去1週間の番組を高品質で完全録音できるPythonアプリケーションです。

**現在の状態**: **Phase 4実装中** - 検索画面完了、設定画面実装中。キーボードナビゲーションUI完全対応に向けて進行中。

## 🎯 **現在の開発目標**

### 主要機能（実装完了）
1. **過去番組表取得**: 日付指定による番組一覧表示
2. **タイムフリー録音**: 日付・番組名指定による完全録音
3. **高品質録音**: HLS制約回避による2.5時間番組も完全対応
4. **メタデータ対応**: ID3タグ自動埋め込み（番組名、出演者、放送局、日付）
5. **キーボードナビゲーションUI**: 上下キー・エンター操作による直感的UI

### パフォーマンス実績
- **録音速度**: 10分番組を5.48秒で録音完了（実時間の1/110高速処理）
- **並行処理**: 8セグメント同時ダウンロード（平均107セグメント/秒）
- **品質**: MP3 256kbps, 48kHz, ID3タグ付き高品質録音（99.99%時間精度）

## 🚀 **現在の開発状況（Phase 4）**

### ✅ **完了済み機能**
- **Phase 1-3**: 基盤システム・認証・CLI統合・RecordingWorkflow統合完了
- **検索画面**: 5種類の検索方法・ページング・キーボードナビゲーション完了
- **メインメニュー**: 検索機能統合・ナビゲーション完了

### 🔄 **現在実装中**
- **設定画面**: 地域設定・音質設定・保存先設定・通知設定
- **システム情報画面**: システム状態・録音履歴・統計情報

### 📋 **残りタスク**
- **Phase 4統合テスト**: 新規画面と既存UIの統合テスト
- **パフォーマンス最適化**: メモリ効率化・応答速度向上

## 🏗️ **アーキテクチャ**

### タイムフリー専用コアモジュール (`src/`)
- `timefree_recorder.py`: タイムフリー専用録音システム
- `program_history.py`: 過去番組表管理・検索
- `auth.py`: タイムフリー認証システム
- `streaming.py`: タイムフリー専用ストリーミング
- `program_info.py`: 番組情報管理
- `cli.py`: タイムフリー専用対話型CLI
- `region_mapper.py`: 47都道府県対応地域設定
- `utils/`: 共通ユーティリティ

### キーボードナビゲーションUI (`src/ui/`)
- `screens/`: 画面実装（メインメニュー・検索・設定・システム情報）
- `input/`: キーボード入力処理
- `services/`: UI共通サービス
- `recording_workflow.py`: 録音ワークフロー統合

### テストスイート (`tests/`)
- **単体テスト**: 各モジュールの機能テスト
- **統合テスト**: タイムフリーAPI統合テスト
- **UIテスト**: キーボードナビゲーションテスト
- **E2Eテスト**: 実際のRadiko APIを使用した完全フローテスト

## 🎮 **使用方法**

### 基本的な使用方法
```bash
# キーボードナビゲーションUIモード
python RecRadiko.py ui-mode

# 従来のCLIモード
python RecRadiko.py list-programs 2025-07-15 TBS
python RecRadiko.py record 2025-07-15 TBS "森本毅郎・スタンバイ!"
```

### 主要コマンド
- `ui-mode`: キーボードナビゲーションUI起動
- `list-programs`: 番組表取得
- `record`: 番組録音
- `search-programs`: 番組検索
- `show-region`: 現在の地域設定表示
- `list-prefectures`: 47都道府県一覧表示

## 🔧 **開発環境セットアップ**

```bash
# 依存関係をインストール
pip install -r requirements.txt

# メインスクリプトを実行
python RecRadiko.py ui-mode

# テスト実行
python -m pytest tests/ -v

# 特定のモジュールのテスト
python -m pytest tests/ui/test_search_screen.py -v
```

## 🚨 **開発ルール**

### 必須開発手順
1. **コード変更前**: 既存テストが全て成功していることを確認
2. **新機能実装時**: 対応するテストケースを必ず作成
3. **コード変更後**: 必ずテスト実行・成功確認
4. **テスト失敗時**: 新しいコードはコミット・使用禁止

### テスト実装方針
- **実環境優先**: 可能な限りモックを使わず、実際のファイルシステム・設定ファイルを使用
- **統合テスト重視**: 個別機能より全体的な動作フローを検証
- **実用性検証**: 実際のユーザー操作シナリオに基づくテスト
- **モック使用制限**: UI入力シミュレーション・外部API・システム通知のみに限定

### ブランチ運用
- **開発**: `development`ブランチで実施
- **本番**: `main`ブランチは安定版
- **コミット**: 機能単位でコミット・詳細なメッセージ

### 品質基準
- **テストカバレッジ**: 95%以上維持
- **キー応答時間**: < 50ms
- **画面遷移時間**: < 100ms
- **日本語対応**: 全応答・ドキュメントは日本語

### 不明点確認の徹底
仕様や要件が不明な場合は必ず確認し、勝手に推測して実装することは禁止。

## 🎯 **今後の開発計画**

### Phase 4完了後の計画
1. **コードリファクタリング**: 重複コード統合・型ヒント完全化
2. **GUI機能実装**: tkinter/PyQtによるGUI
3. **機能拡張**: 高品質録音・自動化機能
4. **macOSアプリケーション化**: PyInstaller・コード署名

### 長期目標
- **プロダクション品質**: 企業レベルの安定性・信頼性
- **ユーザビリティ**: 直感的な操作性
- **パフォーマンス**: 高速・効率的な処理
- **保守性**: 拡張しやすいアーキテクチャ

---

**プロジェクト状態**: Phase 4実装中（設定画面）  
**次のマイルストーン**: Phase 4完了・キーボードナビゲーションUI完全対応  
**開発開始日**: 2025年7月13日  
**最終更新**: 2025年7月15日