version: '3.8'

# å®Ÿéš›ã®Radiko APIã‚’ä½¿ç”¨ã™ã‚‹E2Eãƒ†ã‚¹ãƒˆå°‚ç”¨ã®Docker Composeè¨­å®š
# é€šå¸¸ã®E2Eãƒ†ã‚¹ãƒˆç’°å¢ƒã¨ã¯åˆ†é›¢ã—ã¦å®Ÿè¡Œ

services:
  # å®Ÿéš›ã®Radiko APIã‚’ä½¿ç”¨ã™ã‚‹E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œç’°å¢ƒ
  recradiko-real-api-e2e:
    build:
      context: ../../
      dockerfile: tests/e2e/Dockerfile
    container_name: recradiko_real_api_e2e_runner
    volumes:
      - ../../:/app
      - real_api_test_data:/app/test_data
      - real_api_logs:/app/logs
      - real_api_cache:/app/cache
    environment:
      - E2E_TEST_MODE=real_api
      - LOG_LEVEL=DEBUG
      - PYTHONPATH=/app
      # å®Ÿéš›ã®APIã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€SKIP_REAL_API_TESTSã¯è¨­å®šã—ãªã„
      - RADIKO_AREA_ID=JP14
      - TEST_TIMEOUT=300
    networks:
      - real_api_network
    depends_on:
      - real-api-monitor
    command: >
      bash -c "
        echo 'ğŸŒ å®Ÿéš›ã®Radiko APIã‚’ä½¿ç”¨ã™ã‚‹E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œç’°å¢ƒæº–å‚™ä¸­...' &&
        echo 'âš ï¸  ã“ã®ãƒ†ã‚¹ãƒˆã¯å®Ÿéš›ã®Radiko APIã‚’å‘¼ã³å‡ºã—ã¾ã™' &&
        echo 'âš ï¸  APIåˆ©ç”¨è¦ç´„ã‚’éµå®ˆã—ã¦å®Ÿè¡Œã—ã¦ãã ã•ã„' &&
        echo 'ğŸ“… å®Ÿè¡Œé–‹å§‹: $(date)' &&
        python -m pytest tests/e2e/test_real_api.py -v --tb=short &&
        echo 'âœ… å®Ÿéš›ã®Radiko APIãƒ†ã‚¹ãƒˆå®Œäº†: $(date)'
      "

  # å®Ÿéš›ã®APIãƒ†ã‚¹ãƒˆç›£è¦–ãƒ»ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†
  real-api-monitor:
    image: prom/prometheus:latest
    container_name: recradiko_real_api_monitor
    ports:
      - "9091:9090"
    volumes:
      - ./monitoring/prometheus-real-api.yml:/etc/prometheus/prometheus.yml
      - prometheus_real_api_data:/prometheus
    networks:
      - real_api_network
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'

  # å®Ÿéš›ã®APIãƒ†ã‚¹ãƒˆçµæœãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
  real-api-dashboard:
    image: grafana/grafana:latest
    container_name: recradiko_real_api_dashboard
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=realapi
      - GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH=/etc/grafana/provisioning/dashboards/real-api-dashboard.json
    volumes:
      - grafana_real_api_data:/var/lib/grafana
      - ./monitoring/grafana/real-api-dashboards:/etc/grafana/provisioning/dashboards
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources
    networks:
      - real_api_network
    depends_on:
      - real-api-monitor

  # ãƒ†ã‚¹ãƒˆçµæœã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
  real-api-archiver:
    image: alpine:latest
    container_name: recradiko_real_api_archiver
    volumes:
      - real_api_logs:/logs
      - real_api_test_data:/test_data
      - ./archives:/archives
    networks:
      - real_api_network
    command: >
      sh -c "
        echo 'ğŸ“¦ ãƒ†ã‚¹ãƒˆçµæœã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä½œæˆä¸­...' &&
        mkdir -p /archives/$(date +%Y%m%d_%H%M%S) &&
        cp -r /logs/* /archives/$(date +%Y%m%d_%H%M%S)/ 2>/dev/null || true &&
        cp -r /test_data/* /archives/$(date +%Y%m%d_%H%M%S)/ 2>/dev/null || true &&
        echo 'âœ… ãƒ†ã‚¹ãƒˆçµæœã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä½œæˆå®Œäº†' &&
        sleep 3600
      "

volumes:
  real_api_test_data:
    driver: local
  real_api_logs:
    driver: local
  real_api_cache:
    driver: local
  prometheus_real_api_data:
    driver: local
  grafana_real_api_data:
    driver: local

networks:
  real_api_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16