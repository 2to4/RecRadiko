# RecRadiko対話型インターフェース仕様書
## バージョン 2.0 - リスト選択形式UI

---

## 1. 概要

### 1.1 目的
RecRadikoタイムフリー専用システムの対話型インターフェースを、従来のコマンド入力方式から直感的なリスト選択形式に改善し、ユーザビリティを大幅に向上させる。

### 1.2 設計方針
- **直感的操作**: 上下キー選択・エンターキー確定による現代的インターフェース
- **段階的選択**: 放送局→日付→番組名の3段階選択フロー
- **エラー防止**: キーボードナビゲーションによる無効入力の根本的排除
- **ユーザー体験**: ハイライト表示・視覚的フィードバックによる明確な操作性

---

## 2. メインメニュー構成

### 2.1 メイン画面
```
====================================
    RecRadiko タイムフリー録音システム
====================================

→ 番組録音 (放送局→日付→番組選択)
  番組検索・一覧表示
  録音履歴表示
  設定管理
  システム情報
  終了

操作: ↑↓キーで選択、Enterで確定、Escで前画面
```

### 2.2 メニュー項目詳細

#### [1] 番組録音
- **機能**: 3段階選択による録音実行
- **フロー**: 放送局選択 → 日付選択 → 番組選択 → 録音実行
- **対象**: タイムフリー録音（過去1週間）

#### [2] 番組検索・一覧表示
- **機能**: 番組表閲覧・検索
- **操作**: 放送局・日付指定による番組一覧表示
- **検索**: 番組名・出演者による部分一致検索

#### [3] 録音履歴表示
- **機能**: 過去の録音結果確認
- **表示**: 録音日時・番組名・ファイルパス・録音状況

#### [4] 設定管理
- **機能**: システム設定の確認・変更
- **項目**: 地域設定・音質設定・保存先設定

#### [5] システム情報
- **機能**: バージョン・API状況確認
- **表示**: 認証状況・システム統計・依存関係確認

---

## 3. 番組録音フロー（詳細仕様）

### 3.1 Step 1: 放送局選択

#### 画面構成
```
====================================
    Step 1/3: 放送局選択
====================================

現在の地域: 東京都 (JP13)

→ TBSラジオ
  文化放送
  ニッポン放送
  ラジオNIKKEI第1
  ラジオNIKKEI第2
  InterFM897
  TOKYO FM
  J-WAVE
  ラジオ日本
  NHKラジオ第1
  NHKラジオ第2
  NHK-FM
  ────────────────────
  地域変更
  メインメニューに戻る

操作: ↑↓キーで選択、Enterで確定、Escで前画面、Rで地域変更
```

#### 機能仕様
- **地域自動検出**: 設定ファイルから現在地域を表示
- **放送局一覧**: 地域に対応した放送局リストを動的生成
- **キーボードナビゲーション**: 上下キーによる選択項目移動
- **視覚的フィードバック**: 選択中項目のハイライト表示（→マーク）
- **ショートカットキー**: R（地域変更）、Esc（前画面）
- **無効項目表示**: 利用不可能な放送局はグレーアウト表示

### 3.2 Step 2: 日付選択

#### 画面構成
```
====================================
    Step 2/3: 日付選択
====================================

選択された放送局: TBSラジオ

利用可能な日付 (過去1週間):

→ 2025-07-15 (今日)
  2025-07-14 (昨日)
  2025-07-13 (2日前)
  2025-07-12 (3日前)
  2025-07-11 (4日前)
  2025-07-10 (5日前)
  2025-07-09 (6日前)
  ────────────────────
  放送局を変更
  メインメニューに戻る

操作: ↑↓キーで選択、Enterで確定、Escで前画面、Bで放送局変更
```

#### 機能仕様
- **動的日付生成**: 現在日時から過去7日間を自動生成
- **日本語表示**: 「今日」「昨日」「N日前」の直感的表示
- **タイムフリー制限**: Radikoのタイムフリー仕様（1週間）に準拠
- **キーボードナビゲーション**: 上下キーによるスムーズな日付選択
- **ショートカットキー**: B（放送局変更）、Esc（前画面）
- **選択状態表示**: 現在選択中の日付をハイライト表示

### 3.3 Step 3: 番組選択

#### 画面構成
```
====================================
    Step 3/3: 番組選択
====================================

放送局: TBSラジオ
日付: 2025-07-14 (昨日)

番組一覧:

→ 05:00-05:05 芹ゆう子　お気づきかしら（仮） (5分)
  05:05-06:00 早朝ニュース (55分)
  06:00-08:30 森本毅郎・スタンバイ! (150分)
  08:30-11:00 伊集院光とらじおと (150分)
  11:00-13:00 ジェーン・スー 生活は踊る (120分)
  ...
  ────────────────────
  番組検索
  日付を変更
  メインメニューに戻る

操作: ↑↓キーで選択、Enterで確定、Escで前画面
      Page↑↓でページ送り、Sで番組検索、Dで日付変更
```

#### 機能仕様
- **番組表取得**: 指定日・指定局の番組表をAPI取得
- **時間表示**: 放送時間・番組長を明確表示
- **キーボードナビゲーション**: 上下キーによる番組選択
- **ページング**: Page Up/Down キーによる大量番組の効率的表示
- **ショートカットキー**: S（番組検索）、D（日付変更）、Esc（前画面）
- **長時間番組表示**: スクロール可能な番組リスト表示

### 3.4 Step 4: 録音実行確認

#### 画面構成
```
====================================
    録音実行確認
====================================

録音対象番組:
  放送局: TBSラジオ
  日付: 2025-07-14
  時間: 05:00-05:05
  番組名: 芹ゆう子　お気づきかしら（仮）
  長さ: 5分

保存設定:
  形式: MP3 (256kbps)
  保存先: ~/Downloads/RecRadiko/
  ファイル名: TBSラジオ_20250714_0500_芹ゆう子お気づきかしら.mp3

→ 録音開始
  設定変更
  ────────────────────
  番組を変更
  メインメニューに戻る

操作: ↑↓キーで選択、Enterで確定、Escで前画面、Cで設定変更
```

#### 機能仕様
- **録音情報確認**: 全選択内容の最終確認画面
- **ファイル名プレビュー**: 保存予定ファイル名の事前表示
- **キーボードナビゲーション**: 上下キーによる選択肢移動
- **ショートカットキー**: C（設定変更）、Esc（前画面）
- **視覚的強調**: 録音開始項目のデフォルト選択状態
- **実行前確認**: Enter長押しによる誤操作防止

---

## 4. 番組検索機能

### 4.1 検索画面
```
====================================
    番組検索
====================================

[1] 番組名で検索
[2] 出演者で検索
[3] 時間帯で検索
[4] 放送局で絞り込み
[5] 日付範囲で絞り込み

[99] メインメニューに戻る
[0] 終了

検索方法を選択してください (1-5, 99, 0): 
```

### 4.2 検索結果表示
```
====================================
    検索結果: "森本毅郎"
====================================

見つかった番組: 3件

[1] TBSラジオ 2025-07-14 06:00-08:30
    森本毅郎・スタンバイ! (150分)

[2] TBSラジオ 2025-07-13 06:00-08:30
    森本毅郎・スタンバイ! (150分)

[3] TBSラジオ 2025-07-12 06:00-08:30
    森本毅郎・スタンバイ! (150分)

録音する番組を選択してください (1-3):
[77] 新しい検索
[99] メインメニューに戻る
[0] 終了

選択してください (1-3, 77, 99, 0): 
```

---

## 5. エラーハンドリング

### 5.1 入力エラー処理
```
無効な選択です。有効な番号 (1-12, 88, 99, 0) を入力してください。
再入力: 
```

### 5.2 API接続エラー
```
====================================
    接続エラー
====================================

Radiko APIへの接続に失敗しました。

考えられる原因:
- インターネット接続の問題
- Radiko APIの一時的な障害
- 認証情報の期限切れ

[1] 再試行
[2] 設定確認
[99] メインメニューに戻る
[0] 終了

選択してください (1-2, 99, 0): 
```

### 5.3 録音エラー
```
====================================
    録音エラー
====================================

録音中にエラーが発生しました。

エラー詳細: セグメント取得失敗 (85/120完了)
経過時間: 4.2秒 / 予想5.1秒

[1] 再試行
[2] エラー詳細表示
[3] ログファイル確認
[99] メインメニューに戻る
[0] 終了

選択してください (1-3, 99, 0): 
```

---

## 6. プログレス表示

### 6.1 録音進行状況
```
====================================
    録音中: 芹ゆう子　お気づきかしら（仮）
====================================

進捗: ████████████████████░░  85% (102/120セグメント)
速度: 実時間の1/110 (推定残り時間: 0.9秒)
品質: MP3 256kbps, 48kHz
サイズ: 15.2MB / 予想18.3MB

[並行ダウンロード: 8セグメント同時]
✓ セグメント 95-102 完了
→ セグメント 103-110 ダウンロード中...

[Ctrl+C] 録音中止
```

### 6.2 番組表取得中
```
====================================
    番組表取得中...
====================================

TBSラジオ (2025-07-14) の番組情報を取得しています

進捗: ████████████░░░░░░░░  60%
取得済み: 14番組 / 予想24番組

しばらくお待ちください...
```

---

## 7. 設定管理画面

### 7.1 設定メニュー
```
====================================
    設定管理
====================================

現在の設定:

[1] 地域設定: 東京都 (JP13)
[2] 音質設定: MP3 256kbps, 48kHz
[3] 保存先: ~/Downloads/RecRadiko/
[4] 録音後処理: ID3タグ自動付与
[5] 通知設定: macOS標準通知 有効

[6] 設定をデフォルトに戻す
[7] 設定ファイルエクスポート
[8] 設定ファイルインポート

[99] メインメニューに戻る
[0] 終了

変更する項目を選択してください (1-8, 99, 0): 
```

### 7.2 地域設定変更
```
====================================
    地域設定変更
====================================

現在: 東京都 (JP13)

[1] 北海道・東北地方
[2] 関東地方
[3] 中部地方
[4] 近畿地方
[5] 中国・四国地方
[6] 九州・沖縄地方

[77] 都道府県名で直接指定
[88] 現在の設定を維持
[99] 設定メニューに戻る

地方を選択してください (1-6, 77, 88, 99): 
```

---

## 8. システム情報画面

### 8.1 システム状況
```
====================================
    システム情報
====================================

RecRadiko タイムフリー専用システム v2.0

■ システム状況
認証状況: ✓ 正常 (有効期限: 2025-07-15 15:30)
API接続: ✓ 正常 (応答時間: 0.12秒)
FFmpeg: ✓ 利用可能 (v6.0.1)

■ 録音統計
総録音回数: 47回
成功率: 99.99% (1回失敗)
総録音時間: 23時間41分
平均速度: 実時間の1/95

■ システム要件
Python: 3.11.6 ✓
依存関係: 7/7 インストール済み ✓
ディスク容量: 2.1GB利用可能 ✓

[1] 詳細統計表示
[2] ログファイル確認
[3] 依存関係チェック
[99] メインメニューに戻る

選択してください (1-3, 99): 
```

---

## 9. 技術仕様

### 9.1 キーボードナビゲーション仕様

#### 9.1.1 基本キー操作
- **↑/↓キー**: リスト項目間の移動（循環選択対応）
- **Enterキー**: 選択項目の確定・実行
- **Escキー**: 前画面に戻る・キャンセル操作
- **Page Up/Down**: 長いリストのページ送り（10項目単位）

#### 9.1.2 ショートカットキー
- **R**: 地域変更（放送局選択画面）
- **B**: 放送局変更（日付選択画面）
- **S**: 番組検索（番組選択画面）
- **D**: 日付変更（番組選択画面）
- **C**: 設定変更（録音確認画面）
- **Q**: 終了（全画面共通）

#### 9.1.3 視覚的フィードバック
- **選択インジケータ**: → マークによる現在選択項目表示
- **区切り線**: ──── による論理グループ分離
- **無効項目**: グレーアウト表示による選択不可視覚化
- **ハイライト**: 背景色・文字色による選択状態強調

### 9.2 アーキテクチャ要件
- **入力処理**: getch()による非ブロッキングキー入力受付
- **画面制御**: ANSI エスケープシーケンスによる画面制御・カーソル操作
- **状態管理**: セッション内での選択状態・カーソル位置保持
- **エラー復旧**: 各段階での戻る・やり直し機能

### 9.3 実装ガイドライン
- **クラス設計**: KeyboardNavigator基底クラス + 各メニュー実装クラス
- **デザインパターン**: State pattern による画面遷移管理
- **キー入力処理**: Observer pattern によるキーイベント配信
- **テスト戦略**: Mock keyboard inputによる自動テスト
- **国際化対応**: 将来的な英語UI対応を考慮した文言分離

### 9.4 パフォーマンス要件
- **キー応答時間**: キー押下から画面更新まで < 50ms
- **カーソル移動**: 上下キー連続操作での滑らかな移動
- **API取得**: 番組表取得 < 3秒
- **メモリ使用量**: 番組データキャッシュ < 50MB
- **画面描画**: フリッカーフリーな画面更新・部分描画対応

---

## 10. 実装優先度

### 10.1 Phase 1 (最高優先度)
- メインメニュー基盤実装
- 3段階番組録音フロー (放送局→日付→番組)
- 基本エラーハンドリング

### 10.2 Phase 2 (高優先度)
- 番組検索機能
- 設定管理画面
- プログレス表示改善

### 10.3 Phase 3 (中優先度)
- システム情報表示
- 録音履歴管理
- 高度なエラー復旧機能

---

## 11. ユーザビリティ向上ポイント

### 11.1 直感的操作
- 番号選択による操作統一
- 明確な選択肢表示
- 段階的な情報提示

### 11.2 エラー防止
- 入力値の事前検証
- 無効選択の即座フィードバック
- 操作確認画面の設置

### 11.3 効率性
- **最小限のキー操作**: 上下キー・Enterのみで完結
- **ショートカットキー**: 頻繁操作の1キー実行
- **前回選択記憶**: 画面復帰時の選択位置復元
- **循環選択**: リスト端でのスムーズな反対端移動

---

**文書バージョン**: 2.0  
**作成日**: 2025-07-15  
**更新日**: 2025-07-15（キーボードナビゲーション対応）  
**承認**: システム設計チーム