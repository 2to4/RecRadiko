# RecRadiko タイムフリー専用アプリケーション仕様書

## 概要

RecRadikoを、Radikoのタイムフリー機能に特化したアプリケーションに変更する。ライブ録音の制約（HLS 5分制限）を回避し、過去1週間の番組を自由に録音できるシステムを構築する。

## 基本方針

- **ライブ録音機能の完全削除**: HLS制約による5分制限を回避
- **タイムフリー専用**: 過去1週間の番組のみを対象
- **高品質録音**: タイムフリーAPIによる完全な番組録音
- **直感的操作**: 日付と番組名による簡単指定

## 機能仕様

### 1. 過去番組表取得機能

#### 1.1 機能概要
指定された日付範囲の番組表を取得し、録音可能な番組一覧を表示する。

#### 1.2 入力仕様
- **日付指定**: YYYY-MM-DD形式（例: 2025-07-10）
- **日付範囲**: 現在日時から7日前まで
- **放送局指定**: 放送局ID（例: TBS）または放送局名（例: TBSラジオ）

#### 1.3 出力仕様
- **番組リスト**: 指定日の全番組情報
  - 番組名
  - 放送時間（開始-終了）
  - 番組ID
  - 番組説明
  - 出演者情報
  - 録音可能状況

#### 1.4 APIエンドポイント
```
GET https://radiko.jp/v3/program/date/{YYYYMMDD}/{area_id}.xml
```

#### 1.5 データ形式
```json
{
  "date": "2025-07-10",
  "station_id": "TBS",
  "station_name": "TBSラジオ",
  "programs": [
    {
      "program_id": "TBS_20250710_060000",
      "title": "森本毅郎・スタンバイ!",
      "start_time": "06:00:00",
      "end_time": "08:30:00",
      "duration_minutes": 150,
      "description": "森本毅郎がお送りする情報番組",
      "performers": ["森本毅郎", "松井宏夫"],
      "available": true,
      "timefree_end": "2025-07-17T08:30:00"
    }
  ]
}
```

#### 1.6 対話型コマンド
```
# 特定日の番組表取得
list-programs 2025-07-10 TBS

# 複数日の番組表取得
list-programs 2025-07-08 2025-07-10 TBS

# 全放送局の番組表取得
list-programs 2025-07-10
```

### 2. 日付・番組指定録音機能

#### 2.1 機能概要
日付と番組名を指定して、タイムフリーAPIから該当番組を録音する。

#### 2.2 入力仕様
- **日付**: YYYY-MM-DD形式
- **番組名**: 完全一致または部分一致
- **放送局**: 放送局IDまたは名前
- **出力形式**: mp3, aac, wav（デフォルト: mp3）
- **音質**: 128kbps, 256kbps, 320kbps（デフォルト: 256kbps）

#### 2.3 出力仕様
- **録音ファイル**: 指定形式での音声ファイル
- **ファイル名**: `{station}_{date}_{program_title}.{extension}`
- **メタデータ**: ID3タグ情報の埋め込み
  - タイトル: 番組名
  - アーティスト: 出演者
  - アルバム: 放送局名
  - 日付: 放送日
  - ジャンル: Radio

#### 2.4 タイムフリーAPI仕様
```
# 認証付きタイムフリーURL取得
GET https://radiko.jp/v2/api/ts/playlist.m3u8?station_id={STATION}&l=15&lsid={LSID}&ft={START_TIME}&to={END_TIME}

# パラメータ:
# station_id: 放送局ID
# l: セッション長（固定値15）
# lsid: セッションID
# ft: 開始時刻（YmdHis形式）
# to: 終了時刻（YmdHis形式）
```

#### 2.5 録音プロセス
1. **番組検索**: 日付・番組名から該当番組を特定
2. **タイムフリー認証**: Radiko認証とタイムフリーセッション取得
3. **プレイリスト取得**: M3U8プレイリストの取得
4. **セグメントダウンロード**: 全セグメントの並行ダウンロード
5. **音声結合**: TSセグメントの結合とフォーマット変換
6. **メタデータ付与**: ID3タグ情報の埋め込み

#### 2.6 対話型コマンド
```
# 基本録音
record 2025-07-10 TBS 森本毅郎・スタンバイ!

# 部分一致での録音
record 2025-07-10 TBS 森本毅郎

# 番組IDでの直接指定
record-id TBS_20250710_060000
```

## 技術仕様

### 3.1 削除対象機能
- **ライブ録音機能**: `src/live_streaming.py`の完全削除
- **リアルタイム監視**: プレイリスト監視機能の削除
- **スケジューリング**: 将来録音のスケジュール機能削除

### 3.2 新規実装機能
- **タイムフリーAPI統合**: `src/timefree.py`
- **過去番組表取得**: `src/program_history.py`
- **番組検索機能**: 日付・名前による検索
- **メタデータ処理**: ID3タグ埋め込み機能

### 3.3 既存機能の改修
- **認証システム**: タイムフリー認証への対応
- **ストリーミング**: タイムフリーURL生成
- **CLI**: タイムフリー専用コマンド体系
- **ファイル管理**: メタデータ付きファイル管理

## エラーハンドリング

### 4.1 番組検索エラー
- **番組未発見**: 候補番組の提示
- **日付範囲外**: 利用可能期間の表示
- **タイムフリー期限切れ**: 期限情報の通知

### 4.2 録音エラー
- **認証失敗**: 再認証の自動実行
- **セグメント取得失敗**: 自動リトライ
- **ディスク容量不足**: 容量確認とクリーンアップ

## ユーザーインターフェース

### 5.1 対話型モード
```
RecRadiko タイムフリー録音システム
利用可能なコマンド: list-programs, record, record-id, search-programs, help, exit

RecRadiko> list-programs 2025-07-10 TBS
[番組リスト表示]

RecRadiko> record 2025-07-10 TBS 森本毅郎・スタンバイ!
録音を開始しました: 森本毅郎・スタンバイ! (2025-07-10 06:00-08:30)
録音中: ████████████████████████████████ 100% [02:30:00<00:00]
録音完了: TBS_20250710_森本毅郎・スタンバイ!.mp3
```

## パフォーマンス要件

### 6.1 録音性能
- **2.5時間番組**: 10分以内での録音完了
- **並行録音**: 最大3番組の同時録音対応
- **品質**: オリジナル音質での完全録音

### 6.2 検索性能
- **番組表取得**: 1日分を3秒以内
- **番組検索**: 1週間分を5秒以内
- **キャッシュ**: 取得済み番組表の24時間キャッシュ

## セキュリティ要件

### 7.1 認証情報
- **セッション管理**: 暗号化された認証情報保存
- **自動更新**: 期限切れ時の自動再認証
- **ログ保護**: 認証情報のログ出力禁止

### 7.2 利用制限
- **レート制限**: APIリクエストの適切な間隔制御
- **同時接続**: 過度な並行接続の制限
- **利用規約**: Radiko利用規約の遵守

## 移行計画

### 8.1 段階的移行
1. **フェーズ1**: タイムフリー機能の実装
2. **フェーズ2**: ライブ録音機能の無効化
3. **フェーズ3**: UI/UXの最適化
4. **フェーズ4**: ドキュメント更新

### 8.2 後方互換性
- **設定ファイル**: 既存設定の自動移行
- **録音ファイル**: 既存ファイルの継続管理
- **ユーザーデータ**: スケジュール等の適切な処理

## 対話型コマンド例

### 基本操作
```
RecRadiko> list-programs 2025-07-10 TBS
RecRadiko> record 2025-07-10 TBS 森本毅郎・スタンバイ!
RecRadiko> search-programs 森本毅郎
RecRadiko> help
RecRadiko> exit
```

### 利用可能コマンド
- `list-programs [日付] [放送局]` - 番組表取得
- `record [日付] [放送局] [番組名]` - 録音実行
- `record-id [番組ID]` - 番組ID指定録音
- `search-programs [キーワード]` - 番組検索
- `help` - ヘルプ表示
- `exit` - 終了

---

**作成日**: 2025年7月13日  
**バージョン**: 1.0  
**最終更新**: 2025年7月13日